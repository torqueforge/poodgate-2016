#!/usr/bin/env bash

set -e # exit on any error

########
# Do the following by hand to create local branches if you just cloned a new repo
########
# for branch in `git branch -a | grep remotes | grep -v HEAD | grep -v master`; do
#     git branch --track ${branch##*/} $branch
# done

git checkout master
cp Gemfile        Gemfile.newest
cp Gemfile.lock   Gemfile.lock.newest
cp Guardfile      Guardfile.newest
cp test_helper.rb test_helper.rb.newest

branches=()
eval "$(git for-each-ref --shell --format='branches+=(%(refname))' refs/heads/)"
for branch in "${branches[@]}"; do
  _BRANCH_NAME="$(echo ${branch} | cut -d/ -f 3-)"  # chop the refs/heads/ off

  if [ "${_BRANCH_NAME}" != "master" ]
  then
    git checkout ${_BRANCH_NAME}

    # delete some things
    git rm --ignore-unmatch CLASS_SETUP.md
    git rm --ignore-unmatch outline.md
    git rm --ignore-unmatch README.md
    git rm --ignore-unmatch references.txt
    git rm --ignore-unmatch sanity_test.rb
    git rm -rf --ignore-unmatch bin
    rm -rf bin

    # update some things
    cp Gemfile.newest         Gemfile
    git add Gemfile

    cp Gemfile.lock.newest    Gemfile.lock
    git add Gemfile.lock

    cp Guardfile.newest       Guardfile
    git add Guardfile

    cp test_helper.rb.newest  test_helper.rb
    git add test_helper.rb

    if ! git diff-index --quiet HEAD --; then  # if there's anything to commit
        git commit -uno -m 'fixup_branches script'
    fi
  fi
done

echo
echo "Cleaning up tmp files"
git checkout master
rm *.newest
